<div
  class="content-wrapper app-container medical-theme"
  [class.scan-mode]="scanFocus"
>
  <!-- Header -->
  <header
    class="medical-header d-flex align-items-center justify-content-between p-3 mb-3 shadow-sm bg-white"
  >
    <div class="d-flex align-items-center">
      <i class="fas fa-hospital-symbol fa-2x text-primary me-3"></i>
      <h5 class="mb-0 text-primary">Medication Receive</h5>
    </div>
    <div class="time-display text-muted">
      {{ currentTime | date : "HH:mm" }}
    </div>
  </header>

  <!-- Breadcrumb -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary mb-0 shadow-sm">
    <nav aria-label="breadcrumb" class="w-100">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item" [@fadeIn] *ngIf="!hasScanned">
          <a
            routerLink="/receive"
            (click)="showMedicationHistory()"
            class="text-primary"
          >
            <i class="fas fa-notes-medical"></i> Receive Medicine
          </a>
        </li>
        <li class="breadcrumb-item" [@fadeIn] *ngIf="hasScanned">
          <a
            routerLink="/receive"
            (click)="showMedicationHistory()"
            class="text-secondary"
          >
            <i class="fas fa-angle-double-left"></i> Back
          </a>
        </li>
      </ol>
    </nav>
  </nav>

  <!-- Patient List View -->
  <div class="content-view p-3" *ngIf="!hasScanned">
    <section class="mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <input
          id="date"
          type="date"
          [(ngModel)]="selectedDate"
          (change)="onDateChange()"
          class="form-control w-auto"
        />
        <span class="badge bg-info text-dark fs-6">
          <i class="fas fa-file-medical-alt"></i>
          {{ resDataPatientadmit2.length || 0 }} Prescriptions
        </span>
      </div>
    </section>

    <section class="mb-3">
      <div class="btn-group" role="group">
        <button
          type="button"
          class="btn btn-outline-danger"
          (click)="onWaitingClick()"
        >
          <i class="fas fa-ban"></i> Waiting
        </button>
        <button
          type="button"
          class="btn btn-outline-success"
          (click)="onReceivedClick()"
        >
          <i class="fas fa-check-circle"></i> Received
        </button>
      </div>
    </section>

    <section class="patient-list row g-3">
      <div
        class="col-md-6 col-lg-4"
        *ngFor="let patient of resDataPatientadmit2"
      >
        <div
          class="card shadow-sm h-100 medicine-order-card m-0"
          (click)="onClickPatient(patient.prescriptionno)"
        >
          <div class="card-body">
            <div class="d-flex align-items-center mb-2">
              <img
                [src]="patient.photoUrl || './Document/dist/img/avatar5.png'"
                alt="Patient"
                class="rounded-circle me-3 border mr-3"
                width="48"
                height="48"
              />
              <div class="flex-grow-1">
                <div class="fw-bold text-primary mb-1 h5">
                  {{ patient.patientname }}
                </div>
                <div class="small text-muted">
                  Bed: {{ patient.activebed }} | AN: {{ patient.an }}
                </div>
              </div>
              <i class="fas fa-chevron-right text-secondary"></i>
            </div>
            <hr class="my-2" />
            <div class="d-flex flex-wrap gap-2 mr-2 text-lg">
              <span class="badge text-dark">
                RX: {{ patient.prescriptionno }}
              </span>
              <span class="badge bg-success mr-2 text-lg">
                <i class="fas fa-pills"></i>
                {{ patient.countBarcodeY || 0 }}
              </span>
              <span class="badge bg-primary text-dark text-lg">
                <i class="fas fa-print"></i>
                {{ patient.countBarcodeN || 0 }}
              </span>
            </div>
            <div class="small mt-2 text-muted" *ngIf="patient.remark">
              <i class="fas fa-info-circle text-info"></i> {{ patient.remark }}
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Medication Dispensing View -->
  <div class="content-view p-3" *ngIf="hasScanned">
    <section
      class="patient-header d-flex align-items-center mb-4 p-3 bg-white rounded shadow-sm"
    >
      <img
        [src]="
          resDataPatientadmitSel.photoUrl || './Document/dist/img/avatar5.png'
        "
        alt="Patient"
        class="rounded-circle border border-2 border-primary me-3"
        width="64"
        height="64"
        style="object-fit: cover"
      />
      <div class="flex-grow-1">
        <div class="fw-semibold fs-5 text-primary mb-1">
          {{ resDataPatientadmitSel.patientname }}
        </div>
        <div class="d-flex flex-wrap gap-2 small">
          <span class="badge bg-light text-dark border border-secondary">
            <i class="fas fa-bed me-1"></i>
            {{ resDataPatientadmitSel.activebed }}
          </span>
          <span class="badge bg-light text-dark border border-info">
            <i class="fas fa-id-card me-1"></i> {{ resDataPatientadmitSel.an }}
          </span>
          <span class="badge bg-light text-dark border border-primary">
            <i class="fas fa-prescription-bottle-alt me-1"></i>
            {{ resDataPatientadmitSel.prescriptionno }}
          </span>
        </div>
      </div>
    </section>

    <section class="medication-summary d-flex gap-3 mb-4">
      <div
        class="summary-card card text-center flex-fill shadow-sm"
        (click)="filterByType('package')"
      >
        <div class="card-body">
          <i class="fas fa-pills fa-2x text-success mb-2"></i>
          <div class="fs-4">{{ lenPack || 0 }}</div>
          <!-- <div class="text-muted h6">P</div> -->
        </div>
      </div>
      <div
        class="summary-card card text-center flex-fill shadow-sm"
        (click)="filterByType('sticker')"
      >
        <div class="card-body">
          <i class="fas fa-tags fa-2x text-primary mb-2"></i>
          <div class="fs-4">{{ lenSticker || 0 }}</div>
          <!-- <div class="text-muted h6">S</div> -->
        </div>
      </div>
      <div class="summary-card card flex-fill shadow-sm bg-warning p-0">
        <button
          type="button"
          class="btn btn-warning w-100 h-100"
          (click)="openReceiveMsgPopup('SSS')"
        >
          <i class="fas fa-ban"></i> Reject
        </button>
      </div>
      <div
        *ngIf="hasScanned"
        class="summary-card card flex-fill shadow-sm bg-success p-0"
      >
        <button
          type="button"
          class="btn btn-success w-100 h-100 text-light"
          (click)="confirmAllMedications()"
        >
          <i class="fas fa-check-circle"></i> Confirm
        </button>
      </div>
    </section>

    <section class="medication-list">
      <div *ngFor="let barcode of getBarcodes(); let i = index" class="mb-0">
        <div
          class="main-med-card card shadow-sm p-2 mb-2"
          [class.package]="groupedData[barcode][0].sendmachine === 'Y'"
          [class.sticker]="groupedData[barcode][0].sendmachine === 'N'"
          (click)="
            groupedData[barcode][0].expanded = !groupedData[barcode][0].expanded
          "
          [@fadeInLeft]
          [ngClass]="{ receive: isGroupReceived(barcode) }"
        >
          <div class="d-flex align-items-center justify-content-between">
            <span class="badge bg-primary fs-6"
              >{{ i + 1 }}/{{ getBarcodes().length }}</span
            >
            <button
              class="btn btn-outline-info btn-sm"
              (click)="onPopupShelf(getBarcodes()); $event.stopPropagation()"
            >
              <i class="fas fa-archive"></i> Storage
            </button>
            <button
              class="btn btn-outline-success btn-sm"
              (click)="onScanDrung(barcode); $event.stopPropagation()"
            >
              <i class="fas fa-check-circle"></i> Receive
            </button>
            <span class="ms-2">
              <i
                class="fas fa-check-circle text-success"
                *ngIf="isGroupReceived(barcode)"
              ></i>
            </span>
          </div>
          <div class="main-med-info mt-0">
            <span class="text-muted">
              <i class="far fa-clock"></i>
              {{ groupedData[barcode][0].takedate?.substring(0, 10) }}
              {{ formatTimeHM(groupedData[barcode][0].frequencytime) }}
              {{ groupedData[barcode][0].frequencytimedesc }}
            </span>
            <span class="badge bg-light text-dark ms-2">
              {{ groupedData[barcode][0].orderqty }}
              {{ groupedData[barcode][0].orderunitcode }}
            </span>
          </div>
          <ul class="list-group list-group-flush mt-2 p-0">
            <li
              class="list-group-item d-flex align-items-center p-0"
              *ngFor="let med of groupedData[barcode]"
              [class.scanned]="med.recivedatetime"
              [class.overdue]="isTimeOver(med.frequencytime)"
              [class.high-alert]="med.highalert === '1'"
            >
              <img
                [src]="viewDrugs(med.orderitemcode)"
                class="rounded me-3 border mr-3"
                width="60"
                height="60"
                (click)="openImagePopupArr(getAllImageUrls(med.orderitemcode))"
                alt="ยา"
              />
              <div class="flex-grow-1">
                <div class="fw-bold">{{ med.orderitemname }}</div>
                <div class="small text-muted">
                  <i class="fas fa-pills"></i> {{ med.dosage }}
                  {{ med.dosageunitcode }}
                </div>
                <div class="small text-muted">
                  {{ med.freetext2 }} {{ med.freetext3 }}
                </div>
              </div>
              <div class="hospital-toggle-container ms-2">
                <button
                  mat-icon-button
                  [matMenuTriggerFor]="exportMenu"
                  matTooltip="Options"
                  class="btn btn-outline-secondary btn-sm"
                >
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <mat-menu #exportMenu="matMenu">
                  <button mat-menu-item (click)="openRejectPopupItem(med)">
                    <i class="fas fa-ban"></i> Reject
                  </button>
                  <button mat-menu-item (click)="onPreDispensingError(med)">
                    <i class="fas fa-exclamation-triangle"></i> Med Error
                  </button>
                  <button mat-menu-item (click)="onclickoffdrug(med)">
                    <i class="fas fa-times-circle"></i> Off
                  </button>
                  <button mat-menu-item (click)="onclickholddrug(med)">
                    <i class="fas fa-pause-circle"></i> Hold
                  </button>
                </mat-menu>
              </div>
              <span class="badge bg-danger ms-2" *ngIf="med.highalert === '1'"
                >High Alert</span
              >
              <span class="badge bg-success ms-2" *ngIf="med.recivedatetime"
                >Received</span
              >
            </li>
          </ul>
        </div>
      </div>
    </section>
  </div>

  <!-- Legend -->
  <footer class="legend mt-4 p-3 bg-light rounded shadow-sm">
    <div class="d-flex gap-4">
      <div class="legend-item d-flex align-items-center">
        <span class="indicator bg-danger me-2"></span>
        <span>High Alert</span>
      </div>
      <div class="legend-item d-flex align-items-center">
        <span class="indicator bg-success me-2"></span>
        <span>Received</span>
      </div>
    </div>
  </footer>
</div>
