import { Component, EventEmitter, Input, Output, ViewChild, ViewEncapsulation } from '@angular/core';
import Quagga from '@ericblade/quagga2';
import defaultsDeep from 'lodash.defaultsdeep';
import { Subject } from 'rxjs';
import { filter, takeUntil } from 'rxjs/operators';
import { DEFAULT_CONFIG } from './barcode-scanner-livestream.config';
import { mapToReader } from './barcode-types';
import * as i0 from "@angular/core";
export class BarcodeScannerLivestreamComponent {
    constructor() {
        this.maxWidth = '100%';
        this._valueChanges = new Subject();
        // Outputs
        this.valueChanges = new EventEmitter();
        this.started = new EventEmitter();
        this._started = false;
        this._destroyed = new Subject();
        this._valueChanges.pipe(takeUntil(this._destroyed), filter((result) => {
            const errors = result.codeResult.decodedCodes
                .filter(_ => _.error !== undefined)
                .map(_ => _.error);
            const median = this._getMedian(errors);
            //Filter result when median and/or threshold parameters are provided
            //Good result for code_128 : median = 0.08 and threshold = 0.1
            return !this.errorFilter ||
                !(this.errorFilter.median && median > this.errorFilter.median
                    || this.errorFilter.threshold && errors.some(err => err > this.errorFilter.threshold));
        })).subscribe(result => {
            const drawingCtx = Quagga.canvas.ctx.overlay;
            Quagga.ImageDebug.drawPath(result.line, {
                x: 'x',
                y: 'y',
            }, drawingCtx, {
                color: 'red',
                lineWidth: 3,
            });
            this.valueChanges.next(result);
        });
    }
    set torch(value) {
        const track = Quagga.CameraAccess.getActiveTrack();
        if (track) {
            track.applyConstraints({
                advanced: [{ torch: value }],
            });
        }
    }
    get _maxWidth() {
        return this.maxWidth ? `${this.maxWidth}` : 'auto';
    }
    get _maxHeight() {
        return this.maxHeight ? `${this.maxHeight}` : 'auto';
    }
    get isStarted() {
        return this._started;
    }
    ngOnDestroy() {
        this.stop();
        this._destroyed.next(true);
        this._destroyed.complete();
    }
    ngOnChanges() {
        this.restart();
    }
    _init() {
        return new Promise((resolve, reject) => {
            Quagga.onProcessed((result) => this.onProcessed(result));
            Quagga.onDetected((result) => this.onDetected(result));
            this.configQuagga = defaultsDeep({}, this.config, DEFAULT_CONFIG);
            this.configQuagga.inputStream.target = this.barcodeScanner.nativeElement;
            if (this.type) {
                this.configQuagga.decoder.readers = mapToReader(this.type);
            }
            if (this.deviceId) {
                this.configQuagga.inputStream.constraints.deviceId = this.deviceId;
            }
            Quagga.init(this.configQuagga, (err) => {
                if (err) {
                    console.log(err);
                    return reject(err);
                }
                resolve();
            });
        });
    }
    _getMedian(arr) {
        arr.sort((a, b) => a - b);
        const half = Math.floor(arr.length / 2);
        if (arr.length % 2 === 1) // Odd length
            return arr[half];
        return (arr[half - 1] + arr[half]) / 2.0;
    }
    async start() {
        if (!this._started) {
            await this._init();
            Quagga.start();
            this._started = true;
            this.started.next(true);
        }
    }
    stop() {
        if (this._started) {
            Quagga.stop();
            this._started = false;
            this.started.next(false);
        }
    }
    restart() {
        if (this._started) {
            this.stop();
            this.start();
        }
    }
    onProcessed(result) {
        const drawingCtx = Quagga.canvas.ctx.overlay;
        const drawingCanvas = Quagga.canvas.dom.overlay;
        if (result) {
            if (result.boxes) {
                drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute('width'), 10), parseInt(drawingCanvas.getAttribute('height'), 10));
                result.boxes.filter((box) => {
                    return box !== result.box;
                }).forEach((box) => {
                    Quagga.ImageDebug.drawPath(box, {
                        x: 0,
                        y: 1,
                    }, drawingCtx, {
                        color: 'green',
                        lineWidth: 2,
                    });
                });
            }
            if (result.box) {
                Quagga.ImageDebug.drawPath(result.box, {
                    x: 0,
                    y: 1,
                }, drawingCtx, {
                    color: '#00F',
                    lineWidth: 2,
                });
            }
        }
    }
    onDetected(result) {
        this._valueChanges.next(result);
    }
}
BarcodeScannerLivestreamComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.11", ngImport: i0, type: BarcodeScannerLivestreamComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });
BarcodeScannerLivestreamComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.2.11", type: BarcodeScannerLivestreamComponent, selector: "barcode-scanner-livestream", inputs: { type: "type", deviceId: "deviceId", maxWidth: "maxWidth", maxHeight: "maxHeight", config: "config", errorFilter: "errorFilter", torch: "torch" }, outputs: { valueChanges: "valueChanges", started: "started" }, viewQueries: [{ propertyName: "barcodeScanner", first: true, predicate: ["BarcodeScanner"], descendants: true }], usesOnChanges: true, ngImport: i0, template: "<div\n  #BarcodeScanner\n  class=\"scanner\"\n  [hidden]=\"!isStarted\"\n  [style.max-height]=\"_maxHeight\"\n  [style.max-width]=\"_maxWidth\"\n>\n  <video [style.max-height]=\"_maxHeight\" [style.max-width]=\"_maxWidth\"></video>\n  <canvas\n    [style.max-height]=\"_maxHeight\"\n    [style.max-width]=\"_maxWidth\"\n    class=\"drawingBuffer\"\n  ></canvas>\n</div>\n", styles: [".scanner{position:relative}.scanner video,.scanner canvas{width:100%;height:100%}.scanner canvas.drawingBuffer{position:absolute;left:0;top:0}\n"], encapsulation: i0.ViewEncapsulation.None });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.11", ngImport: i0, type: BarcodeScannerLivestreamComponent, decorators: [{
            type: Component,
            args: [{ selector: 'barcode-scanner-livestream', encapsulation: ViewEncapsulation.None, template: "<div\n  #BarcodeScanner\n  class=\"scanner\"\n  [hidden]=\"!isStarted\"\n  [style.max-height]=\"_maxHeight\"\n  [style.max-width]=\"_maxWidth\"\n>\n  <video [style.max-height]=\"_maxHeight\" [style.max-width]=\"_maxWidth\"></video>\n  <canvas\n    [style.max-height]=\"_maxHeight\"\n    [style.max-width]=\"_maxWidth\"\n    class=\"drawingBuffer\"\n  ></canvas>\n</div>\n", styles: [".scanner{position:relative}.scanner video,.scanner canvas{width:100%;height:100%}.scanner canvas.drawingBuffer{position:absolute;left:0;top:0}\n"] }]
        }], ctorParameters: function () { return []; }, propDecorators: { type: [{
                type: Input
            }], deviceId: [{
                type: Input
            }], maxWidth: [{
                type: Input
            }], maxHeight: [{
                type: Input
            }], config: [{
                type: Input
            }], errorFilter: [{
                type: Input
            }], torch: [{
                type: Input
            }], valueChanges: [{
                type: Output
            }], started: [{
                type: Output
            }], barcodeScanner: [{
                type: ViewChild,
                args: ['BarcodeScanner']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFyY29kZS1zY2FubmVyLWxpdmVzdHJlYW0uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWJhcmNvZGUtc2Nhbm5lci9zcmMvbGliL2JhcmNvZGUtc2Nhbm5lci1saXZlc3RyZWFtL2JhcmNvZGUtc2Nhbm5lci1saXZlc3RyZWFtLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1iYXJjb2RlLXNjYW5uZXIvc3JjL2xpYi9iYXJjb2RlLXNjYW5uZXItbGl2ZXN0cmVhbS9iYXJjb2RlLXNjYW5uZXItbGl2ZXN0cmVhbS5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0gsU0FBUyxFQUFjLFlBQVksRUFBRSxLQUFLLEVBQXdCLE1BQU0sRUFBRSxTQUFTLEVBQUUsaUJBQWlCLEVBQ3pHLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sTUFBc0QsTUFBTSxvQkFBb0IsQ0FBQztBQUN4RixPQUFPLFlBQVksTUFBTSxxQkFBcUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7QUFROUMsTUFBTSxPQUFPLGlDQUFpQztJQXFEMUM7UUEvQ1MsYUFBUSxHQUFHLE1BQU0sQ0FBQztRQW9CM0Isa0JBQWEsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBRTlCLFVBQVU7UUFDQSxpQkFBWSxHQUFHLElBQUksWUFBWSxFQUF3QixDQUFDO1FBRXhELFlBQU8sR0FBRyxJQUFJLFlBQVksRUFBVyxDQUFDO1FBWXhDLGFBQVEsR0FBRyxLQUFLLENB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USxpQ0FBaUM7bUhBQWpDLGlDQUFpQyxvYUNoQjlDLHFYQWNBOzRGREVhLGlDQUFpQztrQkFON0MsU0FBUzsrQkFDSSw0QkFBNEIsaUJBR3ZCLGlCQUFpQixDQUFDLElBQUk7MEVBSTVCLElBQUk7c0JBQVosS0FBSztnQkFFRyxRQUFRO3NCQUFoQixLQUFLO2dCQUVHLFFBQVE7c0JBQWhCLEtBQUs7Z0JBRUcsU0FBUztzQkFBakIsS0FBSztnQkFFRyxNQUFNO3NCQUFkLEtBQUs7Z0JBRUcsV0FBVztzQkFBbkIsS0FBSztnQkFLTyxLQUFLO3NCQUFqQixLQUFLO2dCQVlJLFlBQVk7c0JBQXJCLE1BQU07Z0JBRUcsT0FBTztzQkFBaEIsTUFBTTtnQkFFc0IsY0FBYztzQkFBMUMsU0FBUzt1QkFBQyxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIENvbXBvbmVudCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIE91dHB1dCwgVmlld0NoaWxkLCBWaWV3RW5jYXBzdWxhdGlvblxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCBRdWFnZ2EsIHsgUXVhZ2dhSlNDb25maWdPYmplY3QsIFF1YWdnYUpTUmVzdWx0T2JqZWN0IH0gZnJvbSAnQGVyaWNibGFkZS9xdWFnZ2EyJztcbmltcG9ydCBkZWZhdWx0c0RlZXAgZnJvbSAnbG9kYXNoLmRlZmF1bHRzZGVlcCc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IERFRkFVTFRfQ09ORklHIH0gZnJvbSAnLi9iYXJjb2RlLXNjYW5uZXItbGl2ZXN0cmVhbS5jb25maWcnO1xuaW1wb3J0IHsgbWFwVG9SZWFkZXIgfSBmcm9tICcuL2JhcmNvZGUtdHlwZXMnO1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ2JhcmNvZGUtc2Nhbm5lci1saXZlc3RyZWFtJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vYmFyY29kZS1zY2FubmVyLWxpdmVzdHJlYW0uY29tcG9uZW50Lmh0bWwnLFxuICAgIHN0eWxlVXJsczogWycuL2JhcmNvZGUtc2Nhbm5lci1saXZlc3RyZWFtLmNvbXBvbmVudC5zY3NzJ10sXG4gICAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZSxcbn0pXG5leHBvcnQgY2xhc3MgQmFyY29kZVNjYW5uZXJMaXZlc3RyZWFtQ29tcG9uZW50IGltcGxlbWVudHMgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuICAgIC8vIElucHV0c1xuICAgIEBJbnB1dCgpIHR5cGU6IHN0cmluZyB8IHN0cmluZ1tdO1xuXG4gICAgQElucHV0KCkgZGV2aWNlSWQ6IHN0cmluZztcblxuICAgIEBJbnB1dCgpIG1heFdpZHRoID0gJzEwMCUnO1xuXG4gICAgQElucHV0KCkgbWF4SGVpZ2h0OiBzdHJpbmc7XG5cbiAgICBASW5wdXQoKSBjb25maWc6IFBhcnRpYWw8UXVhZ2dhSlNDb25maWdPYmplY3Q+O1xuXG4gICAgQElucHV0KCkgZXJyb3JGaWx0ZXI6IHtcbiAgICAgICAgbWVkaWFuPzogbnVtYmVyXG4gICAgICAgIHRocmVzaG9sZD86IG51bWJlclxuICAgIH1cblxuICAgIEBJbnB1dCgpIHNldCB0b3JjaCh2YWx1ZTogYm9vbGVhbikge1xuICAgICAgY29uc3QgdHJhY2sgPSBRdWFnZ2EuQ2FtZXJhQWNjZXNzLmdldEFjdGl2ZVRyYWNrKCk7XG4gICAgICBpZiAodHJhY2spIHtcbiAgICAgICAgdHJhY2suYXBwbHlDb25zdHJhaW50cyh7XG4gICAgICAgICAgYWR2YW5jZWQ6IFt7IHRvcmNoOiB2YWx1ZSB9IGFzIGFueV0sXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIF92YWx1ZUNoYW5nZXMgPSBuZXcgU3ViamVjdCgpO1xuXG4gICAgLy8gT3V0cHV0c1xuICAgIEBPdXRwdXQoKSB2YWx1ZUNoYW5nZXMgPSBuZXcgRXZlbnRFbWl0dGVyPFF1YWdnYUpTUmVzdWx0T2JqZWN0PigpO1xuXG4gICAgQE91dHB1dCgpIHN0YXJ0ZWQgPSBuZXcgRXZlbnRFbWl0dGVyPGJvb2xlYW4+KCk7XG5cbiAgICBAVmlld0NoaWxkKCdCYXJjb2RlU2Nhbm5lcicpIGJhcmNvZGVTY2FubmVyOiBFbGVtZW50UmVmPEhUTUxEaXZFbGVtZW50PjtcblxuICAgIGdldCBfbWF4V2lkdGgoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWF4V2lkdGggPyBgJHt0aGlzLm1heFdpZHRofWAgOiAnYXV0byc7XG4gICAgfVxuXG4gICAgZ2V0IF9tYXhIZWlnaHQoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWF4SGVpZ2h0ID8gYCR7dGhpcy5tYXhIZWlnaHR9YCA6ICdhdXRvJztcbiAgICB9XG5cbiAgICBwcml2YXRlIF9zdGFydGVkID0gZmFsc2U7XG5cbiAgICBnZXQgaXNTdGFydGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fc3RhcnRlZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9kZXN0cm95ZWQ6IFN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xuXG4gICAgcHJpdmF0ZSBjb25maWdRdWFnZ2E6IFF1YWdnYUpTQ29uZmlnT2JqZWN0O1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG5cbiAgICAgICAgdGhpcy5fdmFsdWVDaGFuZ2VzLnBpcGUoXG4gICAgICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveWVkKSxcbiAgICAgICAgICAgIGZpbHRlcigocmVzdWx0OiBRdWFnZ2FKU1Jlc3VsdE9iamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yczogbnVtYmVyW10gPSByZXN1bHQuY29kZVJlc3VsdC5kZWNvZGVkQ29kZXNcbiAgICAgICAgICAgICAgICAgICAgLmZpbHRlcihfID0+IF8uZXJyb3IgIT09IHVuZGVmaW5lZClcbiAgICAgICAgICAgICAgICAgICAgLm1hcChfID0+IF8uZXJyb3IpO1xuXG5cbiAgICAgICAgICAgICAgICBjb25zdCBtZWRpYW4gPSB0aGlzLl9nZXRNZWRpYW4oZXJyb3JzKTtcblxuICAgICAgICAgICAgICAgIC8vRmlsdGVyIHJlc3VsdCB3aGVuIG1lZGlhbiBhbmQvb3IgdGhyZXNob2xkIHBhcmFtZXRlcnMgYXJlIHByb3ZpZGVkXG4gICAgICAgICAgICAgICAgLy9Hb29kIHJlc3VsdCBmb3IgY29kZV8xMjggOiBtZWRpYW4gPSAwLjA4IGFuZCB0aHJlc2hvbGQgPSAwLjFcbiAgICAgICAgICAgICAgICByZXR1cm4gIXRoaXMuZXJyb3JGaWx0ZXIgfHxcbiAgICAgICAgICAgICAgICAgICAgISh0aGlzLmVycm9yRmlsdGVyLm1lZGlhbiAmJiBtZWRpYW4gPiB0aGlzLmVycm9yRmlsdGVyLm1lZGlhblxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgdGhpcy5lcnJvckZpbHRlci50aHJlc2hvbGQgJiYgZXJyb3JzLnNvbWUoZXJyID0+IGVyciA+IHRoaXMuZXJyb3JGaWx0ZXIudGhyZXNob2xkKSlcbiAgICAgICAgICAgIH0pLFxuICAgICAgICApLnN1YnNjcmliZShyZXN1bHQgPT4ge1xuICAgICAgICAgICAgY29uc3QgZHJhd2luZ0N0eCA9IFF1YWdnYS5jYW52YXMuY3R4Lm92ZXJsYXk7XG5cbiAgICAgICAgICAgIFF1YWdnYS5JbWFnZURlYnVnLmRyYXdQYXRoKHJlc3VsdC5saW5lLCB7XG4gICAgICAgICAgICAgICAgeDogJ3gnLFxuICAgICAgICAgICAgICAgIHk6ICd5JyxcbiAgICAgICAgICAgIH0sIGRyYXdpbmdDdHgsIHtcbiAgICAgICAgICAgICAgICBjb2xvcjogJ3JlZCcsXG4gICAgICAgICAgICAgICAgbGluZVdpZHRoOiAzLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMudmFsdWVDaGFuZ2VzLm5leHQocmVzdWx0KTtcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgICAgIHRoaXMuX2Rlc3Ryb3llZC5uZXh0KHRydWUpO1xuICAgICAgICB0aGlzLl9kZXN0cm95ZWQuY29tcGxldGUoKTtcbiAgICB9XG5cbiAgICBuZ09uQ2hhbmdlcygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5yZXN0YXJ0KCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaW5pdCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIFF1YWdnYS5vblByb2Nlc3NlZCgocmVzdWx0KSA9PiB0aGlzLm9uUHJvY2Vzc2VkKHJlc3VsdCkpO1xuXG4gICAgICAgICAgICBRdWFnZ2Eub25EZXRlY3RlZCgocmVzdWx0KSA9PiB0aGlzLm9uRGV0ZWN0ZWQocmVzdWx0KSk7XG5cbiAgICAgICAgICAgIHRoaXMuY29uZmlnUXVhZ2dhID0gZGVmYXVsdHNEZWVwKHt9LCB0aGlzLmNvbmZpZywgREVGQVVMVF9DT05GSUcpO1xuXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ1F1YWdnYS5pbnB1dFN0cmVhbS50YXJnZXQgPSB0aGlzLmJhcmNvZGVTY2FubmVyLm5hdGl2ZUVsZW1lbnQ7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLnR5cGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZ1F1YWdnYS5kZWNvZGVyLnJlYWRlcnMgPSBtYXBUb1JlYWRlcih0aGlzLnR5cGUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodGhpcy5kZXZpY2VJZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnUXVhZ2dhLmlucHV0U3RyZWFtLmNvbnN0cmFpbnRzLmRldmljZUlkID0gdGhpcy5kZXZpY2VJZDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgUXVhZ2dhLmluaXQodGhpcy5jb25maWdRdWFnZ2EsIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0TWVkaWFuKGFycjogbnVtYmVyW10pOiBudW1iZXIge1xuICAgICAgICBhcnIuc29ydCgoYSwgYikgPT4gYSAtIGIpO1xuICAgICAgICBjb25zdCBoYWxmID0gTWF0aC5mbG9vcihhcnIubGVuZ3RoIC8gMik7XG4gICAgICAgIGlmIChhcnIubGVuZ3RoICUgMiA9PT0gMSkgLy8gT2RkIGxlbmd0aFxuICAgICAgICAgICAgcmV0dXJuIGFycltoYWxmXTtcbiAgICAgICAgcmV0dXJuIChhcnJbaGFsZiAtIDFdICsgYXJyW2hhbGZdKSAvIDIuMDtcbiAgICB9XG5cblxuICAgIGFzeW5jIHN0YXJ0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAoIXRoaXMuX3N0YXJ0ZWQpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2luaXQoKTtcbiAgICAgICAgICAgIFF1YWdnYS5zdGFydCgpO1xuICAgICAgICAgICAgdGhpcy5fc3RhcnRlZCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0ZWQubmV4dCh0cnVlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0b3AoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLl9zdGFydGVkKSB7XG4gICAgICAgICAgICBRdWFnZ2Euc3RvcCgpO1xuICAgICAgICAgICAgdGhpcy5fc3RhcnRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5zdGFydGVkLm5leHQoZmFsc2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVzdGFydCgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuX3N0YXJ0ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc3RvcCgpO1xuICAgICAgICAgICAgdGhpcy5zdGFydCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25Qcm9jZXNzZWQocmVzdWx0OiBRdWFnZ2FKU1Jlc3VsdE9iamVjdCk6IGFueSB7XG4gICAgICAgIGNvbnN0IGRyYXdpbmdDdHggPSBRdWFnZ2EuY2FudmFzLmN0eC5vdmVybGF5O1xuICAgICAgICBjb25zdCBkcmF3aW5nQ2FudmFzID0gUXVhZ2dhLmNhbnZhcy5kb20ub3ZlcmxheTtcblxuICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICBpZiAocmVzdWx0LmJveGVzKSB7XG4gICAgICAgICAgICAgICAgZHJhd2luZ0N0eC5jbGVhclJlY3QoMCwgMCxcbiAgICAgICAgICAgICAgICAgICAgcGFyc2VJbnQoZHJhd2luZ0NhbnZhcy5nZXRBdHRyaWJ1dGUoJ3dpZHRoJyksIDEwKSxcbiAgICAgICAgICAgICAgICAgICAgcGFyc2VJbnQoZHJhd2luZ0NhbnZhcy5nZXRBdHRyaWJ1dGUoJ2hlaWdodCcpLCAxMCkpO1xuICAgICAgICAgICAgICAgIHJlc3VsdC5ib3hlcy5maWx0ZXIoKGJveDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBib3ggIT09IHJlc3VsdC5ib3g7XG4gICAgICAgICAgICAgICAgfSkuZm9yRWFjaCgoYm94OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgUXVhZ2dhLkltYWdlRGVidWcuZHJhd1BhdGgoYm94LCB7XG4gICAgICAgICAgICAgICAgICAgICAgICB4OiAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgeTogMSxcbiAgICAgICAgICAgICAgICAgICAgfSwgZHJhd2luZ0N0eCwge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6ICdncmVlbicsXG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lV2lkdGg6IDIsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocmVzdWx0LmJveCkge1xuICAgICAgICAgICAgICAgIFF1YWdnYS5JbWFnZURlYnVnLmRyYXdQYXRoKHJlc3VsdC5ib3gsIHtcbiAgICAgICAgICAgICAgICAgICAgeDogMCxcbiAgICAgICAgICAgICAgICAgICAgeTogMSxcbiAgICAgICAgICAgICAgICB9LCBkcmF3aW5nQ3R4LCB7XG4gICAgICAgICAgICAgICAgICAgIGNvbG9yOiAnIzAwRicsXG4gICAgICAgICAgICAgICAgICAgIGxpbmVXaWR0aDogMixcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25EZXRlY3RlZChyZXN1bHQ6IFF1YWdnYUpTUmVzdWx0T2JqZWN0KTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3ZhbHVlQ2hhbmdlcy5uZXh0KHJlc3VsdCk7XG4gICAgfVxuXG59XG5cbiIsIjxkaXZcbiAgI0JhcmNvZGVTY2FubmVyXG4gIGNsYXNzPVwic2Nhbm5lclwiXG4gIFtoaWRkZW5dPVwiIWlzU3RhcnRlZFwiXG4gIFtzdHlsZS5tYXgtaGVpZ2h0XT1cIl9tYXhIZWlnaHRcIlxuICBbc3R5bGUubWF4LXdpZHRoXT1cIl9tYXhXaWR0aFwiXG4+XG4gIDx2aWRlbyBbc3R5bGUubWF4LWhlaWdodF09XCJfbWF4SGVpZ2h0XCIgW3N0eWxlLm1heC13aWR0aF09XCJfbWF4V2lkdGhcIj48L3ZpZGVvPlxuICA8Y2FudmFzXG4gICAgW3N0eWxlLm1heC1oZWlnaHRdPVwiX21heEhlaWdodFwiXG4gICAgW3N0eWxlLm1heC13aWR0aF09XCJfbWF4V2lkdGhcIlxuICAgIGNsYXNzPVwiZHJhd2luZ0J1ZmZlclwiXG4gID48L2NhbnZhcz5cbjwvZGl2PlxuIl19